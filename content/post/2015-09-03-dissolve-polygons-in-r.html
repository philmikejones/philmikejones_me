---
title: Dissolve polygons in R
date: 2015-09-03
author: philmikejones
categories:
  - GIS
  - rstats
tags:
  - dissolve
  - gis
  - polygon
  - r
---



<div id="update-2018-02-07---using-sf" class="section level2">
<h2>Update 2018-02-07 - using <code>sf</code></h2>
<p>In the last couple of years or so the <a href="https://cran.r-project.org/package=sf"><code>sf</code> package</a> has replaced most of the functionality of <code>rgdal</code> and <code>rgeos</code>. It has a number of advantages over these older packages:</p>
<ul>
<li>They don’t use the <a href="http://adv-r.had.co.nz/S4.html">S4 object system</a>, which means no more <code>@</code> slots.</li>
<li><code>sf</code> functions are generally faster than <code>rgdal</code> counterparts.</li>
<li><code>sf</code> data frames conform to <a href="http://r4ds.had.co.nz/tidy-data.html">tidy data</a> principles and there are <code>dplyr</code> verbs to manipulate them.</li>
<li><code>sf</code> functions no longer drop the data frame, which many of the <code>rgdal</code> functions did.</li>
</ul>
<p>Overall, then, <code>sf</code> is much more convenient and efficient to work with, so I’ve updated my tutoral to use this new package. The older <code>rgdal</code> based tutorial will of course still work.</p>
<p>Dissolving polygons is another fairly elementary GIS task that I need to perform regularly. With R this is can be a bit involved, but once done is fully reproducible and the code can be re-used. This post is essentially a companion piece to <a href="https://philmikejones.me/post/2015-09-01-clipping-polygons-in-r/">Clipping polygons in R</a>; I wrote both because I often forget how to complete these tasks in R.</p>
</div>
<div id="getting-started" class="section level2">
<h2>Getting started</h2>
<p>Let’s gather together everything we need to complete this example. We need a shapefile of small geographies to ‘dissolve’, a lookup table to tell us which polygons dissolve into which, and we need a couple of R spatial packages to run everything. Let’s get started.</p>
<pre># The default behaviour of this script is to create a folder called 'dissolve-example'
# and download and run everything from here.
# You can change this by modifying the next two lines
dir.create("dissolve-example")
setwd("dissolve-example")

# Load a few packages. dplyr makes merges easier
require("rgdal")
require("rgeos")
require("dplyr")

# Set up shapefile to dissolve. I'm using English regions
download.file("http://census.edina.ac.uk/ukborders/easy_download/prebuilt/shape/England_gor_2011.zip",
              destfile = "lad-region-lookup.zip")
unzip("lad-region-lookup.zip", exdir = ".")
region &lt;- readOGR(".", "England_gor_2011")

# Check the shapefile has loaded correctly
plot(region)</pre>
<figure id="attachment_1725" class="thumbnail wp-caption aligncenter" style="width: 610px">
<img class="size-full wp-image-1725" src="https://i2.wp.com/philmikejones.me/wp-content/uploads/2015/09/region.png?fit=600%2C454" alt="Regions" srcset="https://i0.wp.com/philmikejones.me/wp-content/uploads/2015/09/region.png?w=600 600w, https://i1.wp.com/philmikejones.me/wp-content/uploads/2015/09/region.png?resize=300%2C227 300w" sizes="(max-width: 600px) 100vw, 600px" data-recalc-dims="1" />
<figcaption class="caption wp-caption-text">
Regions
</figcaption>
</figure>
<pre># We're going to dissolve all regions in to one country (England!)
# For this we'll create a lookup table and merge with the spatial data
# Hopefully for your 'real' data you have a lookup table of all polygons and
# their larger geography already!
lu &lt;- data.frame()
lu &lt;- rbind(lu, region@data)
lu$CODE &lt;- as.character(lu$CODE)
lu$NAME &lt;- as.character(lu$NAME)
lu$country &lt;- NA
lu$country &lt;- "England"</pre>
</div>
<div id="merge" class="section level2">
<h2>Merge</h2>
<p>We now need to merge the lookup table into our spatial object data frame. We should end up with one row per zone to dissolve, each with a reference for the relevant larger geography. I think the trick is to make sure the row names match exactly, and if you can match the polygon IDs as well with <tt>spChFIDs()</tt>.</p>
<pre># Merge lu (LookUp) into polygons,
region@data$CODE &lt;- as.character(region@data$CODE)
region@data &lt;- full_join(region@data, lu, by = "CODE")

# Tidy merged data
region@data &lt;- select(region@data, -NAME.x)
colnames(region@data) &lt;- c("code", "name", "country")

# Ensure shapefile row.names and polygon IDs are sensible
row.names(region) &lt;- row.names(region@data)
region &lt;- spChFIDs(region, row.names(region))</pre>
</div>
<div id="dissolve" class="section level2">
<h2>Dissolve</h2>
<p>Now we can do the dissolve. I use <tt>gUnaryUnion</tt> (and indeed I think <tt>unionSpatialPolygons</tt> in the maptools package uses this by default).</p>
<pre># Now the dissolve
region &lt;- gUnaryUnion(region, id = region@data$country)</pre>
<p>If you want to just plot this using base plot you can stop there. If you want to do anything with the data or plot using ggplot you need to recreate the data frame.</p>
<pre># If you want to recreate an object with a data frame
# make sure row names match
row.names(region) &lt;- as.character(1:length(region))

# Extract the data you want (the larger geography)
lu &lt;- unique(lu$country)
lu &lt;- as.data.frame(lu)
colnames(lu) &lt;- "country"  # your data will probably have more than 1 row!

# And add the data back in
region &lt;- SpatialPolygonsDataFrame(region, lu)

# Check it's all worked
plot(region)</pre>
Your plot should look like this:
<figure id="attachment_1722" class="thumbnail wp-caption aligncenter" style="width: 610px">
<img class="size-full wp-image-1722" src="https://i2.wp.com/philmikejones.me/wp-content/uploads/2015/09/dissolve-example.png?fit=600%2C454" alt="Dissolved polygons" srcset="https://i0.wp.com/philmikejones.me/wp-content/uploads/2015/09/dissolve-example.png?w=600 600w, https://i0.wp.com/philmikejones.me/wp-content/uploads/2015/09/dissolve-example.png?resize=300%2C227 300w" sizes="(max-width: 600px) 100vw, 600px" data-recalc-dims="1" />
<figcaption class="caption wp-caption-text">
Example dissolved polygons
</figcaption>
</figure>
<p>And your data frame should look like this:</p>
<pre>region@data
##   country
## 1 England</pre>
</div>
