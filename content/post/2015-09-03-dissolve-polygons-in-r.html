---
title: Dissolve polygons in R
date: 2015-09-03
author: philmikejones
categories:
  - GIS
  - rstats
tags:
  - dissolve
  - gis
  - polygon
  - r
---



<p>Dissolving polygons is another fairly elementary GIS task that I need to perform regularly. With R this is can be a bit involved, but once done is fully reproducible and the code can be re-used. This post is essentially a companion piece to <a href="https://philmikejones.me/post/2015-09-01-clipping-polygons-in-r/">Clipping polygons in R</a>; I wrote both because I often forget how to complete these tasks in R.</p>
<div id="update-2018-02-07---using-sf" class="section level2">
<h2>Update 2018-02-07 - using <code>sf</code></h2>
<p>In the last couple of years or so the <a href="https://cran.r-project.org/package=sf"><code>sf</code> package</a> has replaced most of the functionality of <code>rgdal</code> and <code>rgeos</code>. It has a number of advantages over these older packages:</p>
<ul>
<li>It doesn’t use the <a href="http://adv-r.had.co.nz/S4.html">S4 object system</a>, which means no more <code>@</code> slots.</li>
<li><code>sf</code> functions are generally faster than <code>rgdal</code> counterparts.</li>
<li><code>sf</code> data frames conform to <a href="http://r4ds.had.co.nz/tidy-data.html">tidy data</a> principles and there are <code>dplyr</code> verbs to manipulate them.</li>
</ul>
<p>Overall, then, <code>sf</code> is much more convenient and efficient to work with, so I’ve updated my tutoral to use this new package. The older <code>rgdal</code> based tutorial will of course still work.</p>
<div id="getting-started" class="section level3">
<h3>Getting started</h3>
<p>First, install and load <code>sf</code> for loading the shapefiles, <code>dplyr</code> for manipulating the data, and <code>ggplot2</code> for plotting the maps. You could also load the complete tidyverse but this currently causes problems for loading the development version of <code>ggplot2</code> so use caution. Hopefully this issue will be resolved with an update to <code>ggplot2</code> in the near future.</p>
<pre class="r"><code>if (!require(&quot;dplyr&quot;)) {
  install.packages(&quot;dplyr&quot;)
  library(&quot;dplyr&quot;)
}

if (!require(&quot;sf&quot;)) {
  install.packages(&quot;sf&quot;)
  library(&quot;sf&quot;)
}

# currently (early 2018) you need the development version of ggplot2
# to work with sf
if (!require(&quot;devtools&quot;)) {
  install.packages(&quot;devtools&quot;)
}
devtools::install_github(&quot;tidyverse/ggplot2&quot;)
library(&quot;ggplot2&quot;)</code></pre>
<p>Next we need to download the files we’ll be using. I’ve used regions as a simple example. We’ll download the files to a temporary directory and get started.</p>
<pre class="r"><code>tmp_dir &lt;- tempdir()
tmp     &lt;- tempfile(tmpdir = tmp_dir, fileext = &quot;.zip&quot;)

download.file(
  &quot;http://census.edina.ac.uk/ukborders/easy_download/prebuilt/shape/England_gor_2011.zip&quot;,
  destfile = tmp
)
unzip(tmp, exdir = tmp_dir)</code></pre>
<p>And now load the shapefile we just extracted and plot it to ensure it’s worked:</p>
<pre class="r"><code>regions &lt;- read_sf(tmp_dir, &quot;england_gor_2011&quot;)
ggplot(regions) + geom_sf()</code></pre>
{{< figure src="../../img/regions.png" alt="English regions" caption="English regions" >}}
<p>Now lets have a look at the data (without the geometry):</p>
<pre class="r"><code>head(st_set_geometry(regions, NULL))</code></pre>
<pre><code>##        code                     name     label
## 1 E12000006          East of England E12000006
## 2 E12000007                   London E12000007
## 3 E12000002               North West E12000002
## 4 E12000001               North East E12000001
## 5 E12000004            East Midlands E12000004
## 6 E12000003 Yorkshire and The Humber E12000003</code></pre>
<p>Dissolves with <code>sf()</code> do not save the data frame (other than the geometry column) by default without specifying how to aggregate the data. Using area as an example:</p>
<pre class="r"><code>regions$area &lt;- st_area(regions)
head(st_set_geometry(regions, NULL))</code></pre>
<pre><code>##        code                     name     label        area
## 1 E12000006          East of England E12000006 19575024459
## 2 E12000007                   London E12000007  1594720097
## 3 E12000002               North West E12000002 14915248139
## 4 E12000001               North East E12000001  8676411818
## 5 E12000004            East Midlands E12000004 15814753263
## 6 E12000003 Yorkshire and The Humber E12000003 15564151183</code></pre>
<p>Now we have something some data that’s meaningful to group, we can just use <code>summarise()</code> to group the data and perform the dissolve:</p>
<pre class="r"><code>england &lt;- 
  regions %&gt;% 
  summarise(area = sum(area))</code></pre>
<pre class="r"><code>ggplot(england) + geom_sf()</code></pre>
{{< figure src="../../img/dissolve-preserve-data.png" alt="Dissolve polygons" caption="Dissolve polygons" >}}
<p>If you don’t have or want data to save the dissolve just create a column to <code>group_by()</code> so that the features (rows) that are to be grouped together are given the same data:</p>
<pre class="r"><code>england &lt;- 
  regions %&gt;% 
  mutate(country = &quot;england&quot;) %&gt;% 
  group_by(country) %&gt;% 
  summarise()</code></pre>
</div>
</div>
<div id="original-rgdal-instructions" class="section level2">
<h2>Original <code>rgdal</code> instructions</h2>
<div id="getting-started-1" class="section level3">
<h3>Getting started</h3>
<p>Let’s gather together everything we need to complete this example. We need a shapefile of small geographies to ‘dissolve’, a lookup table to tell us which polygons dissolve into which, and we need a couple of R spatial packages to run everything. Let’s get started.</p>
<pre># The default behaviour of this script is to create a folder called 'dissolve-example'
# and download and run everything from here.
# You can change this by modifying the next two lines
dir.create("dissolve-example")
setwd("dissolve-example")

# Load a few packages. dplyr makes merges easier
require("rgdal")
require("rgeos")
require("dplyr")

# Set up shapefile to dissolve. I'm using English regions
download.file("http://census.edina.ac.uk/ukborders/easy_download/prebuilt/shape/England_gor_2011.zip",
              destfile = "lad-region-lookup.zip")
unzip("lad-region-lookup.zip", exdir = ".")
region &lt;- readOGR(".", "England_gor_2011")

# Check the shapefile has loaded correctly
plot(region)

# We're going to dissolve all regions in to one country (England!)
# For this we'll create a lookup table and merge with the spatial data
# Hopefully for your 'real' data you have a lookup table of all polygons and
# their larger geography already!
lu &lt;- data.frame()
lu &lt;- rbind(lu, region@data)
lu$CODE &lt;- as.character(lu$CODE)
lu$NAME &lt;- as.character(lu$NAME)
lu$country &lt;- NA
lu$country &lt;- "England"</pre>
</div>
</div>
<div id="merge" class="section level2">
<h2>Merge</h2>
<p>We now need to merge the lookup table into our spatial object data frame. We should end up with one row per zone to dissolve, each with a reference for the relevant larger geography. I think the trick is to make sure the row names match exactly, and if you can match the polygon IDs as well with <tt>spChFIDs()</tt>.</p>
<pre># Merge lu (LookUp) into polygons,
region@data$CODE &lt;- as.character(region@data$CODE)
region@data &lt;- full_join(region@data, lu, by = "CODE")

# Tidy merged data
region@data &lt;- select(region@data, -NAME.x)
colnames(region@data) &lt;- c("code", "name", "country")

# Ensure shapefile row.names and polygon IDs are sensible
row.names(region) &lt;- row.names(region@data)
region &lt;- spChFIDs(region, row.names(region))</pre>
</div>
<div id="dissolve" class="section level2">
<h2>Dissolve</h2>
<p>Now we can do the dissolve. I use <tt>gUnaryUnion</tt> (and indeed I think <tt>unionSpatialPolygons</tt> in the maptools package uses this by default).</p>
<pre># Now the dissolve
region &lt;- gUnaryUnion(region, id = region@data$country)</pre>
<p>If you want to just plot this using base plot you can stop there. If you want to do anything with the data or plot using ggplot you need to recreate the data frame.</p>
<pre># If you want to recreate an object with a data frame
# make sure row names match
row.names(region) &lt;- as.character(1:length(region))

# Extract the data you want (the larger geography)
lu &lt;- unique(lu$country)
lu &lt;- as.data.frame(lu)
colnames(lu) &lt;- "country"  # your data will probably have more than 1 row!

# And add the data back in
region &lt;- SpatialPolygonsDataFrame(region, lu)

# Check it's all worked
plot(region)</pre>
<p>And your data frame should look like this:</p>
<pre>region@data
##   country
## 1 England</pre>
</div>
